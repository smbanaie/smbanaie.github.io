{% extends "admin/base.html" %}

{% block title %}مدیریت دسته‌بندی‌ها | کنترل پنل{% end %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">مدیریت دسته‌بندی‌ها</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                            <i class="fas fa-plus"></i> افزودن دسته‌بندی جدید
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if categories %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>نام نمایشی</th>
                                    <th>نام فنی</th>
                                    <th>وضعیت</th>
                                    <th>تعداد پست‌ها</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td>
                                        {{ category[1] }}
                                        {% if category[0] == default_category %}
                                        <span class="badge bg-primary ms-1">پیش‌فرض</span>
                                        {% end %}
                                    </td>
                                    <td><code>{{ category[0] }}</code></td>
                                    <td>
                                        {% if category_status.get(category[0], 'active') == 'active' %}
                                        <span class="badge bg-success">فعال</span>
                                        {% else %}
                                        <span class="badge bg-secondary">غیرفعال</span>
                                        {% end %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ category_counts.get(category[0], 0) }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-warning btn-sm edit-category-btn"
                                                data-name="{{ category[0] }}"
                                                data-display="{{ category[1] }}"
                                                data-status="{{ category_status.get(category[0], 'active') }}"
                                                data-is-default="{% if category[0] == default_category %}1{% else %}0{% end %}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editCategoryModal">
                                            <i class="fas fa-edit"></i> ویرایش
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-category-btn"
                                                data-name="{{ category[0] }}"
                                                data-display="{{ category[1] }}"
                                                data-article-count="{{ category_counts.get(category[0], 0) }}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteCategoryModal">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </td>
                                </tr>
                                {% end %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        هیچ دسته‌بندی موجود نیست. اولین دسته‌بندی را اضافه کنید.
                    </div>
                    {% end %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCategoryModalLabel">افزودن دسته‌بندی جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addCategoryForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newName" class="form-label">نام فنی</label>
                        <input type="text" class="form-control" id="newName" name="name" required
                               placeholder="مثلاً: tech, culture, diary">
                        <div class="form-text">این نام برای لینک‌ها و ساختار فایل استفاده می‌شود</div>
                    </div>
                    <div class="mb-3">
                        <label for="newDisplayName" class="form-label">نام نمایشی</label>
                        <input type="text" class="form-control" id="newDisplayName" name="display_name" required
                               placeholder="مثلاً: فناوری، فرهنگ، خاطرات">
                        <div class="form-text">این نام در منو و صفحات نمایش داده می‌شود</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">وضعیت</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="addCategoryActive" value="active" checked>
                            <label class="form-check-label" for="addCategoryActive">
                                فعال
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="addCategoryInactive" value="inactive">
                            <label class="form-check-label" for="addCategoryInactive">
                                غیرفعال
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addCategoryDefault" name="is_default" value="1">
                            <label class="form-check-label" for="addCategoryDefault">
                                تنظیم به عنوان دسته‌بندی پیش‌فرض
                            </label>
                        </div>
                        <div class="form-text">اگر تیک زده شود، این دسته‌بندی به عنوان پیش‌فرض برای پست‌های جدید استفاده می‌شود</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> افزودن دسته‌بندی
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCategoryModalLabel">ویرایش دسته‌بندی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCategoryForm" method="post">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="old_name" id="editOldName">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editName" class="form-label">نام فنی</label>
                        <input type="text" class="form-control" id="editName" name="new_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDisplayName" class="form-label">نام نمایشی</label>
                        <input type="text" class="form-control" id="editDisplayName" name="new_display_name" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">وضعیت</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="editCategoryActive" value="active">
                            <label class="form-check-label" for="editCategoryActive">
                                فعال
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="editCategoryInactive" value="inactive">
                            <label class="form-check-label" for="editCategoryInactive">
                                غیرفعال
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editCategoryDefault" name="is_default" value="1">
                            <label class="form-check-label" for="editCategoryDefault">
                                تنظیم به عنوان دسته‌بندی پیش‌فرض
                            </label>
                        </div>
                        <div class="form-text">اگر تیک زده شود، این دسته‌بندی به عنوان پیش‌فرض برای پست‌های جدید استفاده می‌شود</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-edit"></i> به‌روزرسانی دسته‌بندی
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Category Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCategoryModalLabel">حذف دسته‌بندی</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteCategoryForm" method="post">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="name" id="deleteName">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>هشدار:</strong> این عملیات غیرقابل بازگشت است!
                    </div>
                    <p>آیا مطمئن هستید که می‌خواهید دسته‌بندی <strong id="deleteDisplayName"></strong> را حذف کنید؟</p>

                    <div class="mb-3" id="migrationOptions" style="display: none;">
                        <label class="form-label"><strong>پردازش پست‌های موجود:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="migration_option" id="migration_keep" value="keep" checked>
                            <label class="form-check-label" for="migration_keep">
                                دسته‌بندی قدیمی را در پست‌ها نگه دار
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="migration_option" id="migration_default" value="default">
                            <label class="form-check-label" for="migration_default">
                                پست‌ها را به دسته‌بندی پیش‌فرض انتقال بده
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="migration_option" id="migration_replace" value="replace">
                            <label class="form-check-label" for="migration_replace">
                                پست‌ها را به دسته‌بندی دیگر انتقال بده
                            </label>
                        </div>
                    </div>

                    <div class="mb-3" id="replacementCategoryDiv" style="display: none;">
                        <label for="replacementCategory" class="form-label">دسته‌بندی جایگزین:</label>
                        <select class="form-select" id="replacementCategory" name="replacement_category">
                            {% for category in categories %}
                            <option value="{{ category[1] }}" data-id="{{ category[0] }}">{{ category[1] }}</option>
                            {% end %}
                        </select>
                    </div>

                    <p class="text-muted">این عملیات دسته‌بندی را از لیست مدیریت حذف کرده و پست‌های موجود را بر اساس انتخاب شما پردازش می‌کند.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> حذف دسته‌بندی
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="categoryErrorModal" tabindex="-1" aria-labelledby="categoryErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryErrorModalLabel">خطا</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div id="categoryErrorMessage"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add category form handler
    document.getElementById('addCategoryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('action', 'add');
        
        fetch('/admin/categories', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.status === 200) {
                // Check if response is HTML (redirect) or plain text error
                return response.text().then(data => {
                    // If it starts with DOCTYPE or contains HTML tags, it's a successful redirect
                    if (data.trim().startsWith('<!DOCTYPE') || data.includes('<html') || data.includes('<body')) {
                        location.reload();
                    } else {
                        // Plain text error message
                        alert('خطا در افزودن دسته‌بندی: ' + data);
                    }
                });
            } else {
                return response.text().then(data => {
                    alert('خطا در افزودن دسته‌بندی: ' + data);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در ارتباط با سرور');
        });
    });

    // Edit category modal setup
    const editModal = document.getElementById('editCategoryModal');
    editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const name = button.getAttribute('data-name');
        const display = button.getAttribute('data-display');
        const status = button.getAttribute('data-status');
        const isDefault = button.getAttribute('data-is-default') === '1';

        document.getElementById('editOldName').value = name;
        document.getElementById('editName').value = name;
        document.getElementById('editDisplayName').value = display;

        // Set status radio buttons
        document.getElementById('editCategoryActive').checked = (status === 'active');
        document.getElementById('editCategoryInactive').checked = (status === 'inactive');

        // Set default checkbox
        document.getElementById('editCategoryDefault').checked = isDefault;
    });

    // Edit category form handler
    document.getElementById('editCategoryForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('/admin/categories', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.status === 200) {
                return response.text().then(data => {
                    if (data.trim().startsWith('<!DOCTYPE') || data.includes('<html') || data.includes('<body')) {
                        location.reload();
                    } else {
                        alert('خطا در ویرایش دسته‌بندی: ' + data);
                    }
                });
            } else {
                return response.text().then(data => {
                    alert('خطا در ویرایش دسته‌بندی: ' + data);
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در ارتباط با سرور');
        });
    });

    // Delete category modal setup
    const deleteModal = document.getElementById('deleteCategoryModal');
    deleteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const name = button.getAttribute('data-name');
        const display = button.getAttribute('data-display');
        const articleCount = parseInt(button.getAttribute('data-article-count')) || 0;

        document.getElementById('deleteName').value = name;
        document.getElementById('deleteDisplayName').textContent = display;

        // Show/hide migration options based on article count
        const migrationOptions = document.getElementById('migrationOptions');
        const replacementDiv = document.getElementById('replacementCategoryDiv');

        if (articleCount > 0) {
            migrationOptions.style.display = 'block';
            // Filter replacement category options to exclude the one being deleted
            const replacementSelect = document.getElementById('replacementCategory');
            const options = replacementSelect.querySelectorAll('option');
            options.forEach(option => {
                if (option.getAttribute('data-id') === name) {
                    option.style.display = 'none';
                } else {
                    option.style.display = 'block';
                }
            });
            // Select first visible option
            const visibleOptions = replacementSelect.querySelectorAll('option[style*="block"]');
            if (visibleOptions.length > 0) {
                replacementSelect.value = visibleOptions[0].value;
            }
        } else {
            migrationOptions.style.display = 'none';
            replacementDiv.style.display = 'none';
        }
    });

    // Migration option handling
    const migrationOptions = document.querySelectorAll('input[name="migration_option"]');
    const replacementDiv = document.getElementById('replacementCategoryDiv');

    migrationOptions.forEach(option => {
        option.addEventListener('change', function() {
            if (this.value === 'replace') {
                replacementDiv.style.display = 'block';
            } else {
                replacementDiv.style.display = 'none';
            }
        });
    });

    // Delete category form handler
    document.getElementById('deleteCategoryForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('/admin/categories', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.status === 200) {
                return response.text().then(data => {
                    if (data.trim().startsWith('<!DOCTYPE') || data.includes('<html') || data.includes('<body')) {
                        location.reload();
                    } else {
                        // Close the delete modal first
                        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal'));
                        if (deleteModal) {
                            deleteModal.hide();
                        }
                        // Show error in Bootstrap modal
                        document.getElementById('categoryErrorMessage').textContent = 'خطا در حذف دسته‌بندی: ' + data;
                        new bootstrap.Modal(document.getElementById('categoryErrorModal')).show();
                    }
                });
            } else {
                return response.text().then(data => {
                    // Close the delete modal first
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal'));
                    if (deleteModal) {
                        deleteModal.hide();
                    }
                    // Show error in Bootstrap modal
                    document.getElementById('categoryErrorMessage').textContent = 'خطا در حذف دسته‌بندی: ' + data;
                    new bootstrap.Modal(document.getElementById('categoryErrorModal')).show();
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در ارتباط با سرور');
        });
    });
});
</script>
{% end %}