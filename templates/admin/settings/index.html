{% extends "admin/base.html" %}

{% block title %}تنظیمات سایت | کنترل پنل{% end %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">تنظیمات سایت</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-info btn-sm" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> ذخیره تنظیمات
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">تنظیمات سایت</h4>
                                </div>
                                <div class="card-body">
                                    <form id="siteSettingsForm" method="post">
                                        <input type="hidden" name="action" value="update_site">
                                        
                                        <div class="mb-3">
                                            <label for="siteRepo" class="form-label">ریپوزیتوری سایت</label>
                                            <input type="url" class="form-control" id="siteRepo" name="site_repo" 
                                                   value="{{ settings['site_repo'] }}" 
                                                   placeholder="https://github.com/username/repo.git">
                                            <div class="form-text">آدرس ریپوزیتوری گیت‌هاب برای انتشار سایت</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="userDir" class="form-label">مسیر پروژه</label>
                                            <input type="text" class="form-control" id="userDir" name="user_dir" 
                                                   value="{{ settings['user_dir'] }}" 
                                                   placeholder="مسیر کامل به پوشه پروژه">
                                            <div class="form-text">مسیر محلی به پوشه پروژه پلیکان</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="defaultImagePath" class="form-label">مسیر تصاویر پیش‌فرض</label>
                                            <input type="text" class="form-control" id="defaultImagePath" name="default_image_path" 
                                                   value="{{ settings['default_image_path'] }}" 
                                                   placeholder="مسیر به پوشه تصاویر">
                                            <div class="form-text">مسیر نسبی به پوشه تصاویر سایت</div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">اطلاعات سیستم</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="info-box">
                                                <span class="info-box-icon bg-info"><i class="fas fa-folder"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">مسیر محتوا</span>
                                                    <span class="info-box-number">{{ settings['content_dir'] }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-box">
                                                <span class="info-box-icon bg-success"><i class="fas fa-users"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">تعداد نویسندگان</span>
                                                    <span class="info-box-number">{{ len(settings['authors']) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-box">
                                                <span class="info-box-icon bg-warning"><i class="fas fa-tags"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">تعداد دسته‌بندی‌ها</span>
                                                    <span class="info-box-number">{{ len(settings['categories']) }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="info-box">
                                                <span class="info-box-icon bg-primary"><i class="fas fa-database"></i></span>
                                                <div class="info-box-content">
                                                    <span class="info-box-text">نوع ذخیره‌سازی</span>
                                                    <span class="info-box-number">فایلی</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info mt-3">
                                        <i class="fas fa-info-circle"></i>
                                        <strong>نکته مهم:</strong> تغییر این تنظیمات تأثیر مستقیم بر ساختار سایت دارد. 
                                        مطمئن شوید که مسیرها به درستی تنظیم شده‌اند.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title">عملیات سیستم</h4>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-header">
                                                    <h5 class="card-title">بازسازی سایت</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">سایت را با تنظیمات جدید بازسازی کنید.</p>
                                                    <button class="btn btn-primary" id="rebuildSiteBtn">
                                                        <i class="fas fa-sync"></i> بازسازی سایت
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-header">
                                                    <h5 class="card-title">پشتیبان‌گیری</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">اطلاعات مهم سایت را پشتیبان‌گیری کنید.</p>
                                                    <button class="btn btn-success" id="backupBtn">
                                                        <i class="fas fa-download"></i> دانلود پشتیبان
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div class="card bg-light">
                                                <div class="card-header">
                                                    <h5 class="card-title">لاگ سیستم</h5>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text">فعالیت‌های اخیر سیستم را مشاهده کنید.</p>
                                                    <button class="btn btn-info" id="viewLogsBtn">
                                                        <i class="fas fa-file-alt"></i> مشاهده لاگ‌ها
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Save settings handler
    document.getElementById('saveSettingsBtn').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('siteSettingsForm'));
        
        fetch('/admin/settings', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            if (data.includes('error') || data.includes('Error')) {
                document.getElementById('errorMessage').textContent = data;
                new bootstrap.Modal(document.getElementById('errorModal')).show();
            } else {
                new bootstrap.Modal(document.getElementById('successModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('errorMessage').textContent = 'خطا در ارتباط با سرور';
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        });
    });

    // Rebuild site handler
    document.getElementById('rebuildSiteBtn').addEventListener('click', function() {
        // This would trigger site rebuild in a real implementation
        alert('بازسازی سایت در حال انجام...');
        // In a real implementation, this would call a rebuild endpoint
    });

    // Backup handler
    document.getElementById('backupBtn').addEventListener('click', function() {
        // This would trigger backup in a real implementation
        alert('در حال دانلود پشتیبان...');
        // In a real implementation, this would call a backup endpoint
    });

    // View logs handler
    document.getElementById('viewLogsBtn').addEventListener('click', function() {
        // This would show logs in a real implementation
        alert('در حال نمایش لاگ‌ها...');
        // In a real implementation, this would show log files
    });
});
</script>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">موفقیت</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>تنظیمات با موفقیت ذخیره شد!</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">باشه</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">خطا</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>خطا در ذخیره تنظیمات!</strong>
                    <p id="errorMessage"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>
{% end %}