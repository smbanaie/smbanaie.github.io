{% extends "admin/base.html" %}

{% block title %}مدیریت کاربران | کنترل پنل{% end %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">مدیریت کاربران</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="fas fa-user-plus"></i> افزودن کاربر جدید
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if users %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>نام کاربری</th>
                                    <th>وضعیت</th>
                                    <th>تعداد پست‌ها</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        {{ user }}
                                        {% if user == default_author %}
                                        <span class="badge bg-primary ms-1">پیش‌فرض</span>
                                        {% end %}
                                    </td>
                                    <td>
                                        {% if user_status.get(user, 'active') == 'active' %}
                                        <span class="badge bg-success">فعال</span>
                                        {% else %}
                                        <span class="badge bg-secondary">غیرفعال</span>
                                        {% end %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ user_counts.get(user, 0) }}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-warning btn-sm edit-user-btn"
                                                data-username="{{ user }}"
                                                data-status="{{ user_status.get(user, 'active') }}"
                                                data-is-default="{% if user == default_author %}1{% else %}0{% end %}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editUserModal">
                                            <i class="fas fa-edit"></i> ویرایش
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-user-btn"
                                                data-username="{{ user }}"
                                                data-post-count="{{ user_counts.get(user, 0) }}"
                                                data-is-default="{% if user == default_author %}true{% else %}false{% end %}"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteUserModal">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </td>
                                </tr>
                                {% end %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        هیچ کاربری موجود نیست. اولین کاربر را اضافه کنید.
                    </div>
                    {% end %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addUserModalLabel">افزودن کاربر جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addUserForm" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">نام کاربری</label>
                        <input type="text" class="form-control" id="newUsername" name="username" required
                               placeholder="مثلاً: username, author_name">
                        <div class="form-text">نام کاربری که برای نویسندگان استفاده می‌شود</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">وضعیت</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="addUserActive" value="active" checked>
                            <label class="form-check-label" for="addUserActive">
                                فعال
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="addUserInactive" value="inactive">
                            <label class="form-check-label" for="addUserInactive">
                                غیرفعال
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addUserDefault" name="is_default" value="1">
                            <label class="form-check-label" for="addUserDefault">
                                تنظیم به عنوان نویسنده پیش‌فرض
                            </label>
                        </div>
                        <div class="form-text">اگر تیک زده شود، این نویسنده به عنوان پیش‌فرض برای پست‌های جدید استفاده می‌شود</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> افزودن کاربر
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel">ویرایش کاربر</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm" method="post">
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="old_username" id="editOldUsername">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">نام کاربری جدید</label>
                        <input type="text" class="form-control" id="editUsername" name="new_username" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">وضعیت</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="editUserActive" value="active">
                            <label class="form-check-label" for="editUserActive">
                                فعال
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="status" id="editUserInactive" value="inactive">
                            <label class="form-check-label" for="editUserInactive">
                                غیرفعال
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editUserDefault" name="is_default" value="1">
                            <label class="form-check-label" for="editUserDefault">
                                تنظیم به عنوان نویسنده پیش‌فرض
                            </label>
                        </div>
                        <div class="form-text">اگر تیک زده شود، این نویسنده به عنوان پیش‌فرض برای پست‌های جدید استفاده می‌شود</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-edit"></i> به‌روزرسانی کاربر
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteUserModalLabel">حذف کاربر</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deleteUserForm" method="post">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="username" id="deleteUsername">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>هشدار امنیتی:</strong> این عملیات غیرقابل بازگشت است!
                    </div>

                    <div class="mb-3">
                        <p class="text-danger"><strong>کاربر مورد حذف:</strong> <span id="deleteUsernameDisplay" class="badge bg-danger"></span></p>
                        <p><strong>تعداد پست‌های موجود:</strong> <span id="deletePostCount" class="badge bg-info">در حال بررسی...</span></p>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>نکات مهم:</strong>
                        <ul class="mb-0 mt-2">
                            <li>پست‌های موجود کاربر حذف نخواهند شد</li>
                            <li>نام نویسنده در پست‌های قدیمی حفظ می‌شود</li>
                            <li>اگر این نویسنده پیش‌فرض است، باید نویسنده دیگری را به عنوان پیش‌فرض انتخاب کنید</li>
                            <li>این عملیات فقط لیست مدیریت را بروزرسانی می‌کند</li>
                        </ul>
                    </div>

                    <div id="defaultAuthorWarning" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-user-shield"></i>
                        <strong>توجه:</strong> این کاربر نویسنده پیش‌فرض است. لطفاً ابتدا نویسنده دیگری را به عنوان پیش‌فرض تنظیم کنید.
                    </div>

                    <p class="text-center font-weight-bold text-muted mt-3">
                        آیا واقعاً می‌خواهید این کاربر را حذف کنید؟
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> حذف کاربر
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="userErrorModal" tabindex="-1" aria-labelledby="userErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userErrorModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger"></i>
                    خطای عملیات
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle"></i>
                    <strong>خطا رخ داده است:</strong>
                    <div id="userErrorMessage" class="mt-2"></div>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-lightbulb"></i>
                    <strong>راهنمایی:</strong>
                    <ul class="mb-0 mt-2">
                        <li>نام کاربری نمی‌تواند خالی باشد</li>
                        <li>نام کاربری باید یکتا باشد</li>
                        <li>نمی‌توانید آخرین نویسنده فعال را حذف کنید</li>
                        <li>نمی‌توانید نویسنده پیش‌فرض را بدون جایگزین حذف کنید</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> بستن
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="userSuccessModal" tabindex="-1" aria-labelledby="userSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userSuccessModalLabel">
                    <i class="fas fa-check-circle text-success"></i>
                    عملیات موفق
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <div id="userSuccessMessage"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-success" data-bs-dismiss="modal">
                    <i class="fas fa-check"></i> تایید
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add user form handler
    document.getElementById('addUserForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        formData.append('action', 'add');

        fetch('/admin/users', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.status === 200) {
                return response.text().then(data => {
                    if (data.trim().startsWith('<!DOCTYPE') || data.includes('<html') || data.includes('<body')) {
                        // Close modal and show success message
                        const addModalEl = document.getElementById('addUserModal');
                        if (addModalEl) {
                            const addModal = bootstrap.Modal.getInstance(addModalEl);
                            if (addModal) {
                                addModal.hide();
                            }
                        }
                        const successMsg = document.getElementById('userSuccessMessage');
                        if (successMsg) successMsg.textContent = 'کاربر جدید با موفقیت اضافه شد!';
                        const successModal = document.getElementById('userSuccessModal');
                        if (successModal) new bootstrap.Modal(successModal).show();

                        // Reload after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Show error in modal - DEBUG MODE: Show raw error
                        const errorMsg = document.getElementById('userErrorMessage');
                        if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Raw Error:</strong><br><code>' + data + '</code><br><br><strong>User-friendly:</strong> خطا در افزودن کاربر';
                        const errorModal = document.getElementById('userErrorModal');
                        if (errorModal) new bootstrap.Modal(errorModal).show();
                    }
                });
            } else {
                return response.text().then(data => {
                    const errorMsg = document.getElementById('userErrorMessage');
                    if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Raw Error:</strong><br><code>' + data + '</code><br><br><strong>User-friendly:</strong> خطا در افزودن کاربر';
                    const errorModal = document.getElementById('userErrorModal');
                    if (errorModal) new bootstrap.Modal(errorModal).show();
                });
            }
        })
        .catch(error => {
            console.error('DELETE network error:', error);
            console.error('DELETE error stack:', error.stack);
            const errorMsg = document.getElementById('userErrorMessage');
            if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Network Error:</strong><br><code>' + error.message + '</code><br><br><strong>Error Stack:</strong><br><code>' + error.stack + '</code><br><br><strong>User-friendly:</strong> خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.';
            const errorModal = document.getElementById('userErrorModal');
            if (errorModal) new bootstrap.Modal(errorModal).show();
        });
    });

    // Edit user modal setup
    const editModal = document.getElementById('editUserModal');
    editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        if (!button) return;

        const username = button.getAttribute('data-username');
        const status = button.getAttribute('data-status');
        const isDefault = button.getAttribute('data-is-default') === '1';

        // Safe element access with null checks
        const editOldUsername = document.getElementById('editOldUsername');
        const editUsername = document.getElementById('editUsername');
        const editUserActive = document.getElementById('editUserActive');
        const editUserInactive = document.getElementById('editUserInactive');
        const editUserDefault = document.getElementById('editUserDefault');

        if (editOldUsername) editOldUsername.value = username;
        if (editUsername) editUsername.value = username;
        if (editUserActive) editUserActive.checked = (status === 'active');
        if (editUserInactive) editUserInactive.checked = (status === 'inactive');
        if (editUserDefault) editUserDefault.checked = isDefault;
    });

    // Edit user form handler
    document.getElementById('editUserForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('/admin/users', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.status === 200) {
                return response.text().then(data => {
                    if (data.trim().startsWith('<!DOCTYPE') || data.includes('<html') || data.includes('<body')) {
                        // Close modal and show success message
                        const editModalEl = document.getElementById('editUserModal');
                        if (editModalEl) {
                            const editModal = bootstrap.Modal.getInstance(editModalEl);
                            if (editModal) {
                                editModal.hide();
                            }
                        }
                        const successMsg = document.getElementById('userSuccessMessage');
                        if (successMsg) successMsg.textContent = 'اطلاعات کاربر با موفقیت بروزرسانی شد!';
                        const successModal = document.getElementById('userSuccessModal');
                        if (successModal) new bootstrap.Modal(successModal).show();

                        // Reload after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Show error in modal
                        const errorMsg = document.getElementById('userErrorMessage');
                        if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Raw Error:</strong><br><code>' + data + '</code><br><br><strong>User-friendly:</strong> خطا در ویرایش کاربر';
                        const errorModal = document.getElementById('userErrorModal');
                        if (errorModal) new bootstrap.Modal(errorModal).show();
                    }
                });
            } else {
                return response.text().then(data => {
                    document.getElementById('userErrorMessage').textContent = 'خطا در ویرایش کاربر: ' + data;
                    new bootstrap.Modal(document.getElementById('userErrorModal')).show();
                });
            }
        })
        .catch(error => {
            console.error('DELETE network error:', error);
            console.error('DELETE error stack:', error.stack);
            const errorMsg = document.getElementById('userErrorMessage');
            if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Network Error:</strong><br><code>' + error.message + '</code><br><br><strong>Error Stack:</strong><br><code>' + error.stack + '</code><br><br><strong>User-friendly:</strong> خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.';
            const errorModal = document.getElementById('userErrorModal');
            if (errorModal) new bootstrap.Modal(errorModal).show();
        });
    });

    // Delete user modal setup
    const deleteModal = document.getElementById('deleteUserModal');
    deleteModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        if (!button) return;

        const username = button.getAttribute('data-username');
        const postCount = button.getAttribute('data-post-count') || 0;
        const isDefault = button.getAttribute('data-is-default') === 'true';

        // Safe element access with null checks
        const deleteUsernameInput = document.getElementById('deleteUsername');
        const deleteUsernameDisplay = document.getElementById('deleteUsernameDisplay');
        const deletePostCount = document.getElementById('deletePostCount');
        const defaultWarning = document.getElementById('defaultAuthorWarning');

        if (deleteUsernameInput) deleteUsernameInput.value = username;
        if (deleteUsernameDisplay) deleteUsernameDisplay.textContent = username;
        if (deletePostCount) deletePostCount.textContent = postCount;

        // Show warning if this is the default author
        if (defaultWarning) {
            if (isDefault) {
                defaultWarning.style.display = 'block';
            } else {
                defaultWarning.style.display = 'none';
            }
        }

        // Update the confirmation message based on post count
        if (deletePostCount && deletePostCount.parentElement) {
            const postInfo = deletePostCount.parentElement;
            if (postCount > 0) {
                postInfo.innerHTML = `<strong>تعداد پست‌های موجود:</strong> <span class="badge bg-warning">${postCount}</span>`;
            } else {
                postInfo.innerHTML = `<strong>تعداد پست‌های موجود:</strong> <span class="badge bg-success">${postCount}</span>`;
            }
        }
    });

    // Delete user form handler
    document.getElementById('deleteUserForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch('/admin/users', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('DELETE response status:', response.status);
            console.log('DELETE response headers:', response.headers);
            if (response.status === 200) {
                return response.text().then(data => {
                    console.log('DELETE response data:', data);
                    console.log('DELETE response data length:', data.length);
                    if (data.trim().startsWith('<!DOCTYPE') || data.includes('<html') || data.includes('<body')) {
                        // Close modal and show success message
                        const deleteModalEl = document.getElementById('deleteUserModal');
                        if (deleteModalEl) {
                            const deleteModal = bootstrap.Modal.getInstance(deleteModalEl);
                            if (deleteModal) {
                                deleteModal.hide();
                            }
                        }
                        const successMsg = document.getElementById('userSuccessMessage');
                        if (successMsg) successMsg.textContent = 'کاربر با موفقیت حذف شد!';
                        const successModal = document.getElementById('userSuccessModal');
                        if (successModal) new bootstrap.Modal(successModal).show();

                        // Reload after a short delay
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        // Close the delete modal first
                        const deleteModalEl = document.getElementById('deleteUserModal');
                        if (deleteModalEl) {
                            const deleteModal = bootstrap.Modal.getInstance(deleteModalEl);
                            if (deleteModal) {
                                deleteModal.hide();
                            }
                        }
                        // Show error in Bootstrap modal
                        const errorMsg = document.getElementById('userErrorMessage');
                        if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Raw Error:</strong><br><code>' + data + '</code><br><br><strong>User-friendly:</strong> خطا در حذف کاربر';
                        const errorModal = document.getElementById('userErrorModal');
                        if (errorModal) new bootstrap.Modal(errorModal).show();
                    }
                });
            } else {
                return response.text().then(data => {
                    console.log('DELETE error response data:', data);
                    console.log('DELETE error response data length:', data.length);
                    // Close the delete modal first
                    const deleteModalEl = document.getElementById('deleteUserModal');
                    if (deleteModalEl) {
                        const deleteModal = bootstrap.Modal.getInstance(deleteModalEl);
                        if (deleteModal) {
                            deleteModal.hide();
                        }
                    }
                    // Show error in Bootstrap modal
                    const errorMsg = document.getElementById('userErrorMessage');
                    if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Raw Error (Status ' + response.status + '):</strong><br><code>' + (data || 'EMPTY RESPONSE') + '</code><br><br><strong>User-friendly:</strong> خطا در حذف کاربر';
                    const errorModal = document.getElementById('userErrorModal');
                    if (errorModal) new bootstrap.Modal(errorModal).show();
                });
            }
        })
        .catch(error => {
            console.error('DELETE network error:', error);
            console.error('DELETE error stack:', error.stack);
            const errorMsg = document.getElementById('userErrorMessage');
            if (errorMsg) errorMsg.innerHTML = '<strong>DEBUG - Network Error:</strong><br><code>' + error.message + '</code><br><br><strong>Error Stack:</strong><br><code>' + error.stack + '</code><br><br><strong>User-friendly:</strong> خطا در ارتباط با سرور. لطفاً دوباره تلاش کنید.';
            const errorModal = document.getElementById('userErrorModal');
            if (errorModal) new bootstrap.Modal(errorModal).show();
        });
    });
});
</script>
{% end %}
