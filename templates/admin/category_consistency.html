<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>بررسی سازگاری دسته‌بندی‌ها | کنترل پنل مدیریت</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <!-- Font Awesome 6 (Free) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- AdminLTE CSS -->
  <link rel="stylesheet" href='{{static_url("css/adminlte.min.css")}}'>
  <!-- RTL Support -->
  <link rel="stylesheet" href='{{static_url("css/rtl.css")}}'>
  <!-- Vazir Font -->
  <style>
    @font-face {
      font-family: 'Vazir';
      src: url('{{static_url("fonts/Vazir-FD-WOL.eot")}}');
      src: url('{{static_url("fonts/Vazir-FD-WOL.eot?#iefix")}}') format('embedded-opentype'),
           url('{{static_url("fonts/Vazir-FD-WOL.woff")}}') format('woff'),
           url('{{static_url("fonts/Vazir-FD-WOL.ttf")}}') format('truetype');
      font-weight: normal;
    }
    @font-face {
      font-family: 'Vazir';
      src: url('{{static_url("fonts/Vazir-Bold-FD-WOL.eot")}}');
      src: url('{{static_url("fonts/Vazir-Bold-FD-WOL.eot?#iefix")}}') format('embedded-opentype'),
           url('{{static_url("fonts/Vazir-Bold-FD-WOL.woff")}}') format('woff'),
           url('{{static_url("fonts/Vazir-Bold-FD-WOL.ttf")}}') format('truetype');
      font-weight: bold;
    }
    body, h1, h2, h3, h4, h5, h6, .card-title, .btn, .nav-link, .dropdown-item {
      font-family: 'Vazir', 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
    }
  </style>
</head>
<body class="bg-light">
<div class="wrapper">
<!-- Main Header -->
<header class="main-header">
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
<div class="container-fluid">
<a class="navbar-brand" href="/admin">
<i class="fas fa-cog"></i> کنترل پنل مدیریت
</a>
<button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu"
aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
<ul class="navbar-nav me-auto">
<li class="nav-item">
<a class="nav-link" href="/admin/posts/add">
<i class="fas fa-plus"></i> افزودن مقاله جدید
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="/admin/posts">
<i class="fas fa-list"></i> لیست مقالات
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="/admin/categories">
<i class="fas fa-tags"></i> مدیریت دسته‌بندی‌ها
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="/admin/users">
<i class="fas fa-users"></i> مدیریت کاربران
</a>
</li>
<li class="nav-item">
<a class="nav-link active" href="/admin/category-consistency">
<i class="fas fa-search"></i> بررسی سازگاری دسته‌بندی‌ها
</a>
</li>
<li class="nav-item">
<a class="nav-link" href="/admin/settings">
<i class="fas fa-cog"></i> تنظیمات
</a>
</li>
</ul>
</div>
</div>
</nav>
</header>

<!-- Sidebar -->
<div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebarMenu"
aria-labelledby="sidebarMenuLabel">
<div class="offcanvas-header">
<h5 class="offcanvas-title" id="sidebarMenuLabel">
<i class="fas fa-bars"></i> منوی ناوبری
</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
</div>
<div class="offcanvas-body p-0">
<ul class="nav flex-column">
<li class="nav-item">
<a class="nav-link text-white" href="/admin">
<i class="fas fa-tachometer-alt"></i> داشبورد
</a>
</li>
<li class="nav-item">
<a class="nav-link text-white" href="/admin/posts/add">
<i class="fas fa-plus"></i> افزودن مقاله جدید
</a>
</li>
<li class="nav-item">
<a class="nav-link text-white" href="/admin/posts">
<i class="fas fa-list"></i> لیست مقالات
</a>
</li>
<li class="nav-item">
<a class="nav-link text-white" href="/admin/categories">
<i class="fas fa-tags"></i> مدیریت دسته‌بندی‌ها
</a>
</li>
<li class="nav-item">
<a class="nav-link text-white" href="/admin/users">
<i class="fas fa-users"></i> مدیریت کاربران
</a>
</li>
<li class="nav-item">
<a class="nav-link active text-white" href="/admin/category-consistency">
<i class="fas fa-search"></i> بررسی سازگاری دسته‌بندی‌ها
</a>
</li>
<li class="nav-item">
<a class="nav-link text-white" href="/admin/settings">
<i class="fas fa-cog"></i> تنظیمات
</a>
</li>
</ul>
</div>
</div>

<!-- Content Wrapper -->
<div class="content-wrapper">
<section class="content container-fluid">

<div class="container-fluid">
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header">
<h3 class="card-title">بررسی سازگاری دسته‌بندی‌ها</h3>
<div class="card-tools">
<button type="button" class="btn btn-primary btn-sm" onclick="location.reload()">
<i class="fas fa-sync"></i> بازخوانی
</button>
</div>
</div>
<div class="card-body">

{% if error %}
<div class="alert alert-danger">
<i class="fas fa-exclamation-triangle"></i>
<strong>خطا:</strong> {{ error }}
</div>
{% else %}

<!-- Summary Cards -->
<div class="row mb-4">
<div class="col-md-3">
<div class="card bg-info text-white">
<div class="card-body text-center">
<h3>{{ len(file_categories) }}</h3>
<p class="mb-0">دسته‌بندی در فایل‌ها</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-warning text-white">
<div class="card-body text-center">
<h3>{{ len(folder_categories) }}</h3>
<p class="mb-0">پوشه‌های دسته‌بندی</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-success text-white">
<div class="card-body text-center">
<h3>{{ len(userconf_categories) }}</h3>
<p class="mb-0">دسته‌بندی در userconf</p>
</div>
</div>
</div>
<div class="col-md-3">
<div class="card bg-danger text-white">
<div class="card-body text-center">
<h3>{{ len(inconsistencies) }}</h3>
<p class="mb-0">ناهماهنگی‌ها</p>
</div>
</div>
</div>
</div>

<!-- Inconsistencies Section -->
{% if inconsistencies %}
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header">
<h5 class="card-title">ناهماهنگی‌های یافت شده</h5>
</div>
<div class="card-body">
{% for inconsistency in inconsistencies %}
<div class="alert alert-warning mb-3">
<div class="d-flex justify-content-between align-items-start">
<div>
{% if inconsistency.type == 'unmapped_file_category' %}
<strong>دسته‌بندی فایل بدون نقشه‌برداری:</strong> "{{ inconsistency.category }}"
<small class="text-muted d-block">{{ inconsistency.files_count }} فایل (نمونه: {{ inconsistency.sample_files|join(', ') }})</small>
{% elif inconsistency.type == 'folder_without_userconf' %}
<strong>پوشه بدون دسته‌بندی userconf:</strong> "{{ inconsistency.folder }}"
<small class="text-muted d-block">{% if inconsistency.has_files %}دارای فایل‌ها{% else %}خالی{% end %}</small>
{% elif inconsistency.type == 'unused_userconf_category' %}
<strong>دسته‌بندی userconf استفاده نشده:</strong> "{{ inconsistency.category_display }}" ({{ inconsistency.category_id }})
<small class="text-muted d-block">هیچ فایلی از این دسته‌بندی استفاده نمی‌کند</small>
{% end %}
</div>
<div>
<button class="btn btn-sm btn-outline-primary" onclick="openReconciliationModal('{{ inconsistency.type }}', '{{ inconsistency.category or inconsistency.folder or inconsistency.category_id }}')">
<i class="fas fa-tools"></i> اصلاح
</button>
</div>
</div>
</div>
{% end %}
</div>
</div>
</div>
</div>
{% else %}
<div class="alert alert-success">
<i class="fas fa-check-circle"></i>
<strong>عالی!</strong> هیچ ناهماهنگی در دسته‌بندی‌ها یافت نشد.
</div>
{% end %}

<!-- Detailed Reports -->
<div class="row">
<!-- File Categories -->
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h5 class="card-title">دسته‌بندی‌های موجود در فایل‌ها</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm">
<thead>
<tr>
<th>دسته‌بندی</th>
<th>تعداد فایل</th>
<th>نمونه فایل‌ها</th>
</tr>
</thead>
<tbody>
{% for category, files in file_categories.items() %}
<tr>
<td><code>{{ category }}</code></td>
<td><span class="badge bg-primary">{{ len(files) }}</span></td>
<td>
<small class="text-muted">
{% for i, file in enumerate(files[:2]) %}
{{ file }}{% if i < len(files[:2]) - 1 %}, {% end %}
{% end %}
{% if len(files) > 2 %}...{% end %}
</small>
</td>
</tr>
{% end %}
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Folder Categories -->
<div class="col-md-6">
<div class="card">
<div class="card-header">
<h5 class="card-title">پوشه‌های دسته‌بندی</h5>
</div>
<div class="card-body">
<div class="row">
{% for folder in folder_categories %}
<div class="col-md-6 mb-2">
<div class="card bg-light">
<div class="card-body p-2 text-center">
<code>{{ folder }}</code>
</div>
</div>
</div>
{% end %}
</div>
</div>
</div>
</div>
</div>

<!-- Userconf Categories -->
<div class="row">
<div class="col-12">
<div class="card">
<div class="card-header">
<h5 class="card-title">دسته‌بندی‌های userconf</h5>
</div>
<div class="card-body">
<div class="table-responsive">
<table class="table table-sm">
<thead>
<tr>
<th>ID</th>
<th>نام نمایشی</th>
</tr>
</thead>
<tbody>
{% for category in userconf_categories %}
<tr>
<td><code>{{ category['id'] }}</code></td>
<td>{{ category['display'] }}</td>
</tr>
{% end %}
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>

{% end %}

</div>
</div>
</div>
</div>

</section>
</div>

<!-- Reconciliation Modal -->
<div class="modal fade" id="reconciliationModal" tabindex="-1" aria-labelledby="reconciliationModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="reconciliationModalLabel">اصلاح ناهماهنگی دسته‌بندی</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<form id="reconciliationForm">
<div class="modal-body">
<input type="hidden" id="inconsistencyType" name="reconciliation_type">
<input type="hidden" id="targetValue" name="target_value">

<div class="mb-3">
<label for="baseCategory" class="form-label">دسته‌بندی پایه</label>
<select class="form-select" id="baseCategory" name="base_category" required>
<option value="">انتخاب دسته‌بندی پایه...</option>
{% for category in userconf_categories %}
<option value="{{ category['id'] }}">{{ category['display'] }} ({{ category['id'] }})</option>
{% end %}
</select>
</div>

<div id="targetCategoriesSection" class="mb-3" style="display: none;">
<label class="form-label">دسته‌بندی‌های هدف</label>
<div id="targetCategoriesList"></div>
</div>

<div class="mb-3">
<label class="form-label">نوع عملیات</label>
<div class="form-check">
<input class="form-check-input" type="radio" name="operation_type" id="addMapping" value="add_mapping" checked>
<label class="form-check-label" for="addMapping">
اضافه کردن نقشه‌برداری (برای دسته‌بندی‌های فایل)
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="operation_type" id="updateFiles" value="update_file_categories">
<label class="form-check-label" for="updateFiles">
به‌روزرسانی دسته‌بندی در فایل‌ها
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="operation_type" id="addUserconf" value="add_userconf_category">
<label class="form-check-label" for="addUserconf">
اضافه کردن به userconf
</label>
</div>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">لغو</button>
<button type="submit" class="btn btn-primary">
<i class="fas fa-save"></i> اعمال تغییرات
</button>
</div>
</form>
</div>
</div>
</div>

<!-- Success/Error Modals -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="resultModalLabel">نتیجه</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div id="resultMessage"></div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-primary" data-bs-dismiss="modal">بستن</button>
</div>
</div>
</div>
</div>

<!-- Main Footer -->
<footer class="main-footer">
<div class="float-right d-none d-sm-inline">
<b>نسخه</b> 1.0.0
</div>
<strong>کنترل پنل مدیریت</strong>
</footer>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- AdminLTE App -->
<script src='{{static_url("js/adminlte.min.js")}}'></script>

<!-- Page Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Reconciliation form handler
    document.getElementById('reconciliationForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        formData.append('action', 'reconcile');

        // Show loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال اجرا...';
        submitBtn.disabled = true;

        fetch('/admin/category-consistency', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            // Close reconciliation modal
            bootstrap.Modal.getInstance(document.getElementById('reconciliationModal')).hide();

            // Show result
            document.getElementById('resultMessage').innerHTML = data;
            new bootstrap.Modal(document.getElementById('resultModal')).show();

            // Reload page after showing result
            setTimeout(() => {
                location.reload();
            }, 3000);
        })
        .catch(error => {
            console.error('Error:', error);
            bootstrap.Modal.getInstance(document.getElementById('reconciliationModal')).hide();
            document.getElementById('resultMessage').innerHTML = '<div class="alert alert-danger">خطا در ارتباط با سرور</div>';
            new bootstrap.Modal(document.getElementById('resultModal')).show();
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
});

// Function to open reconciliation modal
function openReconciliationModal(type, value) {
    document.getElementById('inconsistencyType').value = type;
    document.getElementById('targetValue').value = value;

    // Configure modal based on type
    const targetSection = document.getElementById('targetCategoriesSection');
    const targetList = document.getElementById('targetCategoriesList');

    if (type === 'unmapped_file_category') {
        targetSection.style.display = 'block';
        targetList.innerHTML = `
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="target_categories[]" value="${value}" checked>
                <label class="form-check-label">${value}</label>
            </div>
        `;
        document.getElementById('addMapping').checked = true;
    } else {
        targetSection.style.display = 'none';
        targetList.innerHTML = '';
        document.getElementById('addUserconf').checked = true;
    }

    new bootstrap.Modal(document.getElementById('reconciliationModal')).show();
}
</script>

</body>
</html>
