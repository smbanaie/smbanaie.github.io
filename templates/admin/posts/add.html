<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ "ویرایش مطلب" if edit_mode else "افزودن مطلب جدید" }} | کنترل پنل</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  
  <!-- Font Awesome 6 (Free) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- SimpleMDE CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
  
  <!-- Custom Admin CSS -->
  <link rel="stylesheet" href='{{static_url("css/AdminLTE.css")}}'>
</head>
<body>
<div class="wrapper">
  <div class="content-wrapper">
    <section class="content container-fluid">
      <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{ "ویرایش مطلب" if edit_mode else "افزودن مطلب جدید" }}</h3>
                        <div class="card-tools">
                            {% if edit_mode %}
                            <a href="/admin/posts" class="btn btn-secondary btn-sm me-2">
                                <i class="fas fa-arrow-left"></i> بازگشت به لیست
                            </a>
                            {% else %}
                            <a href="/admin" class="btn btn-secondary btn-sm me-2">
                                <i class="fas fa-arrow-left"></i> بازگشت به داشبورد
                            </a>
                            {% end %}
                            <a href="/admin/posts" class="btn btn-info btn-sm">
                                <i class="fas fa-list"></i> لیست مطالب
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                    <form id="postForm" method="post" enctype="multipart/form-data">
                        {% if edit_mode %}
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="file_path" value="{{ file_path }}">
                        {% else %}
                        <input type="hidden" name="action" value="add">
                        {% end %}
                        
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Content Editor -->
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title">محتوای مطلب</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="contentEditor" class="form-label">متن مطلب</label>
                                            <textarea id="contentEditor" name="article" style="display:none;">{{ article if article else '' }}</textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="summary" class="form-label">چکیده</label>
                                            <textarea class="form-control" id="summary" name="summary" rows="3" 
                                                      placeholder="خلاصه یک جمله‌ای متن">{{ summary if summary else '' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                </div>
                            
                            <div class="col-md-4">
                                <!-- Post Settings -->
                                <div class="card">
                                    <div class="card-header">
                                        <h4 class="card-title">تنظیمات مطلب</h4>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="title" class="form-label">عنوان</label>
                                            <input type="text" class="form-control" id="title" name="title" 
                                                   value="{{ title if title else '' }}" required>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="slug" class="form-label">نام صفحه (URL)</label>
                                            <input type="text" class="form-control" id="slug" name="slug" 
                                                   value="{{ slug if slug else '' }}" required>
                                            <div class="form-text">این نام برای لینک مطلب استفاده می‌شود</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="category" class="form-label">دسته‌بندی</label>
                                            <select class="form-select" id="category" name="category" required>
                                                <option value="">انتخاب دسته‌بندی</option>
                                                {% for key, value in catlist.items() %}
                                                <option value="{{value}}" {% if category_value and value == category_value %}selected{% end %}>{{key}}</option>
                                                {% end for %}
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="authors" class="form-label">نویسنده</label>
                                            <select class="form-select" id="authors" name="authors" required>
                                                <option value="">انتخاب نویسنده</option>
                                                {% for user in authors %}
                                                <option value="{{user}}" {% if authors_value and user == authors_value %}selected{% end %}>{{user}}</option>
                                                {% end for %}
                                            </select>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="tags" class="form-label">برچسب‌ها</label>
                                            <input type="text" class="form-control" id="tags" name="tags" 
                                                   value="{{ tagsvalues if tagsvalues else '' }}" 
                                                   placeholder="برچسب‌ها را با کاما جدا کنید">
                                            <div class="form-text">مثلاً: فناوری, برنامه‌نویسی, وب</div>
                                        </div>
                                        
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="year" class="form-label">سال</label>
                                                    <input type="number" class="form-control" id="year" name="year" 
                                                           value="{{ year if year else '' }}" required>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="month" class="form-label">ماه</label>
                                                    <input type="number" class="form-control" id="month" name="month" 
                                                           value="{{ month if month else '' }}" required>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="image" class="form-label">تصویر شاخص</label>
                                            <div id="imageUploadArea" class="border rounded p-3 text-center" style="border-style: dashed; cursor: pointer;">
                                                <div id="imageUploadContent">
                                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                                    <p class="text-muted mb-2">فایل تصویر را اینجا بکشید و رها کنید</p>
                                                    <p class="text-muted mb-3">یا</p>
                                                    <input type="file" class="form-control" id="image" name="image" accept="image/*" style="display: none;">
                                                    <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('image').click()">
                                                        <i class="fas fa-folder-open"></i> انتخاب فایل
                                                    </button>
                                                </div>
                                                <div id="imagePreview" class="mt-3" style="display: none;">
                                                    <img id="previewImage" src="" class="img-fluid rounded" style="max-height: 200px;">
                                                    <div class="mt-2">
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeImage()">
                                                            <i class="fas fa-trash"></i> حذف تصویر
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-text">فرمت‌های پشتیبانی شده: JPG, PNG, GIF, WebP (حداکثر 5MB)</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="img_desc" class="form-label">توضیح تصویر</label>
                                            <input type="text" class="form-control" id="img_desc" name="img_desc" 
                                                   value="{{ img_desc if img_desc else '' }}" 
                                                   placeholder="توضیح مختصر درباره تصویر">
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="img_adr" class="form-label">مسیر تصویر (اختیاری)</label>
                                            <input type="text" class="form-control" id="img_adr" name="img_adr" 
                                                   value="{{ img_adr if img_adr else '' }}" 
                                                   placeholder="/images/blog/category/year/month/">
                                            <div class="form-text">اگر تصویر را آپلود کنید، این فیلد نادیده گرفته می‌شود</div>
                                        </div>
                                        
                                        <!-- Hidden field to store uploaded image filename -->
                                        <input type="hidden" id="uploaded_image_filename" name="uploaded_image_filename" value="">
                                    </div>
                                </div>
                                
                                <!-- Actions -->
                                <div class="card">
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <i class="fas fa-save"></i> 
                                                {{ "به‌روزرسانی مطلب" if edit_mode else "ذخیره مطلب" }}
                                            </button>
                                            <a href="/admin/posts" class="btn btn-secondary">
                                                <i class="fas fa-times"></i> لغو
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                    </div>
                </div>
            </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">موفقیت</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    <strong>{{ "مطلب با موفقیت به‌روزرسانی شد!" if edit_mode else "مطلب جدید با موفقیت ایجاد شد!" }}</strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">باشه</button>
                <a href="/admin/posts" class="btn btn-secondary">بازگشت به لیست</a>
            </div>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">خطا</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>خطا در ذخیره مطلب!</strong>
                    <p id="errorMessage"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- SimpleMDE JS -->
<script src="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize SimpleMDE editor
    const simplemde = new SimpleMDE({
        element: document.getElementById("contentEditor"),
        spellChecker: false,
        autosave: {
            enabled: true,
            uniqueId: "contentEditor",
            delay: 1000,
        },
        toolbar: [
            "bold", "italic", "heading", "|",
            "quote", "unordered-list", "ordered-list", "|",
            "link", "image", "|",
            "preview", "side-by-side", "fullscreen", "|",
            "guide"
        ]
    });
    
    // Set initial content if editing
    {% if article %}
    const initialContent = `{{ article.replace('\n', '\\n').replace('\r', '\\r').replace('"', '\\"') }}`;
    simplemde.value(initialContent);
    {% end %}
    
    // Form submission handler
    document.getElementById('postForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate form fields
        const title = document.getElementById('title').value.trim();
        const slug = document.getElementById('slug').value.trim();
        const category = document.getElementById('category').value;
        const authors = document.getElementById('authors').value;
        const article = simplemde.value().trim();
        
        if (!title || !slug || !category || !authors || !article) {
            alert('لطفاً تمام فیلدهای اجباری را پر کنید');
            return;
        }
        
        // Validate image if provided
        const uploadedImageFilename = document.getElementById('uploaded_image_filename').value;
        const manualImageFilename = document.getElementById('image').value;
        const imgAdr = document.getElementById('img_adr').value.trim();
        
        if (!uploadedImageFilename && manualImageFilename && !imgAdr) {
            alert('اگر مسیر تصویر را به صورت دستی وارد می‌کنید، لطفاً مسیر تصویر را نیز مشخص کنید');
            return;
        }
        
        // Get form data
        const formData = new FormData(this);
        
        // Add editor content
        const content = simplemde.value();
        formData.set('article', content);
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال ذخیره...';
        submitBtn.disabled = true;
        
        // Submit form
        fetch('/admin/posts/add', {
            method: 'POST',
            body: formData
        })
        .then(response => response.text())
        .then(data => {
            if (data.includes('error') || data.includes('Error')) {
                document.getElementById('errorMessage').textContent = data;
                new bootstrap.Modal(document.getElementById('errorModal')).show();
            } else {
                new bootstrap.Modal(document.getElementById('successModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('errorMessage').textContent = 'خطا در ارتباط با سرور';
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        })
        .finally(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
    
    // Auto-generate slug from title
    document.getElementById('title').addEventListener('input', function() {
        const title = this.value;
        const slug = title
            .toLowerCase()
            .replace(/[^a-z0-9\u0600-\u06FF\uFB8A\u067E\u0686\u06AF]/g, '-')
            .replace(/-+/g, '-')
            .replace(/^-|-$/g, '');
        document.getElementById('slug').value = slug;
    });
    
    // Update image path when category changes
    document.getElementById('category').addEventListener('change', function() {
        const category = this.value;
        const year = document.getElementById('year').value;
        const month = document.getElementById('month').value;
        if (category && year && month) {
            document.getElementById('img_adr').value = `/images/blog/${category}/${year}/${month}/`;
        }
    });
    
    // Update image path when year/month changes
    document.getElementById('year').addEventListener('change', updateImagePath);
    document.getElementById('month').addEventListener('change', updateImagePath);
    
    function updateImagePath() {
        const category = document.getElementById('category').value;
        const year = document.getElementById('year').value;
        const month = document.getElementById('month').value;
        if (category && year && month) {
            document.getElementById('img_adr').value = `/images/blog/${category}/${year}/${month}/`;
        }
    }

    // Image Upload Functionality
    const imageUploadArea = document.getElementById('imageUploadArea');
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const imageUploadContent = document.getElementById('imageUploadContent');
    const uploadedImageFilename = document.getElementById('uploaded_image_filename');

    // Drag and drop functionality
    imageUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        imageUploadArea.style.borderColor = '#007bff';
        imageUploadArea.style.backgroundColor = '#f8f9fa';
    });

    imageUploadArea.addEventListener('dragleave', () => {
        imageUploadArea.style.borderColor = '#dee2e6';
        imageUploadArea.style.backgroundColor = 'white';
    });

    imageUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        imageUploadArea.style.borderColor = '#dee2e6';
        imageUploadArea.style.backgroundColor = 'white';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageUpload(files[0]);
        }
    });

    // File input change
    imageInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleImageUpload(file);
        }
    });

    function handleImageUpload(file) {
        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            alert('فرمت فایل نامعتبر است. لطفاً فقط فایل‌های JPG, PNG, GIF یا WebP انتخاب کنید');
            return;
        }

        // Validate file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
            alert('حجم فایل نباید بیشتر از 5MB باشد');
            return;
        }

        // Validate filename
        const filename = file.name.toLowerCase();
        const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
        const fileExtension = filename.substring(filename.lastIndexOf('.'));
        if (!allowedExtensions.includes(fileExtension)) {
            alert('پسوند فایل نامعتبر است. لطفاً فقط فایل‌های با پسوند JPG, PNG, GIF یا WebP انتخاب کنید');
            return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImage.src = e.target.result;
            imagePreview.style.display = 'block';
            imageUploadContent.style.display = 'none';
        };
        reader.readAsDataURL(file);

        // Upload image
        const formData = new FormData();
        formData.append('image', file);
        formData.append('action', 'upload');

        fetch('/admin/upload-image', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                uploadedImageFilename.value = data.file.filename;
                // Clear the manual image path since we're using uploaded image
                document.getElementById('img_adr').value = '';
                document.getElementById('image').value = '';
            } else {
                alert('خطا در آپلود تصویر: ' + data.error);
                removeImage();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('خطا در آپلود تصویر');
            removeImage();
        });
    }

    function removeImage() {
        // Remove preview
        imagePreview.style.display = 'none';
        imageUploadContent.style.display = 'block';
        previewImage.src = '';
        
        // Clear hidden field
        uploadedImageFilename.value = '';
        
        // If there was a temp image, delete it
        const filename = uploadedImageFilename.value;
        if (filename) {
            fetch('/admin/upload-image', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'action=delete&filename=' + encodeURIComponent(filename)
            })
            .then(response => response.json())
            .then(data => {
                console.log('Temp image deleted:', data);
            })
            .catch(error => {
                console.error('Error deleting temp image:', error);
            });
        }
    }
});
</script>
</body>
</html>